import React, { useState, useEffect } from 'react';
import donationService from '../services/donationService';

const Donations = () => {
  const [donations, setDonations] = useState([]);
  const [alumniList, setAlumniList] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [formData, setFormData] = useState({
    alumni_id: '',
    amount: '',
    date: '',
    purpose: ''
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const [campaigns] = useState([
    {
      id: 1,
      title: 'LCCB Scholarship Fund',
      description: 'Support deserving students achieve their dreams through quality education.',
      goal: 1000000,
      raised: 750000,
      deadline: '2024-12-31',
      category: 'Education',
      image: 'https://placehold.co/600x400/e2e8f0/ffffff?text=Scholarship+Fund'
    },
    {
      id: 2,
      title: 'Campus Innovation Lab',
      description: 'Help build a state-of-the-art innovation laboratory for students.',
      goal: 2000000,
      raised: 1200000,
      deadline: '2024-11-30',
      category: 'Infrastructure',
      image: 'https://placehold.co/600x400/e2e8f0/ffffff?text=Innovation+Lab'
    },
    {
      id: 3,
      title: 'Alumni Emergency Fund',
      description: 'Support alumni facing medical emergencies and natural disasters.',
      goal: 500000,
      raised: 300000,
      deadline: '2024-12-15',
      category: 'Community',
      image: 'https://placehold.co/600x400/e2e8f0/ffffff?text=Emergency+Fund'
    }
  ]);

  const categories = ['All', 'Education', 'Infrastructure', 'Community', 'Research'];
  const [selectedCategory, setSelectedCategory] = useState('All');

  // Fetch all donations on component mount
  useEffect(() => {
    fetchAllDonations();
    fetchAlumniList();
  }, []);

  const fetchAlumniList = async () => {
    try {
      const response = await fetch('http://localhost:5001/api/alumni');
      const data = await response.json();
      setAlumniList(data);
    } catch (err) {
      console.error('Error fetching alumni list:', err);
    }
  };

  const fetchAllDonations = async () => {
    try {
      setLoading(true);
      // Fetch all donations from all alumni
      const data = await donationService.getAllDonations();
      setDonations(data);
    } catch (err) {
      console.error('Error fetching donations:', err);
      setError('Failed to load donations');
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const newDonation = await donationService.createDonation(formData);
      setDonations(prev => [...prev, newDonation]);
      setShowModal(false);
      setFormData({
        alumni_id: '',
        amount: '',
        date: '',
        purpose: ''
      });
      alert('Donation added successfully!');
    } catch (err) {
      console.error('Error creating donation:', err);
      setError(err.response?.data?.error || 'Failed to add donation');
    } finally {
      setLoading(false);
    }
  };

  const filteredCampaigns = selectedCategory === 'All'
    ? campaigns
    : campaigns.filter(campaign => campaign.category === selectedCategory);

  const formatAmount = (amount) => {
    return new Intl.NumberFormat('en-PH', {
      style: 'currency',
      currency: 'PHP'
    }).format(amount);
  };

  const calculateProgress = (raised, goal) => {
    return Math.min((raised / goal) * 100, 100);
  };

  return (
    <div className="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        {/* Header Section */}
        <div className="text-center mb-12">
          <h1 className="text-3xl font-bold text-gray-900 sm:text-4xl">
            Support Our Causes
          </h1>
          <p className="mt-4 text-xl text-gray-600">
            Join us in making a difference through your generous contributions
          </p>
        </div>

        {/* Categories */}
        <div className="flex flex-wrap justify-center gap-2 mb-12">
          {categories.map((category) => (
            <button
              key={category}
              onClick={() => setSelectedCategory(category)}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors duration-200 ${
                selectedCategory === category
                  ? 'bg-blue-600 text-white'
                  : 'bg-white text-gray-600 hover:bg-gray-100'
              } border border-gray-200`}
            >
              {category}
            </button>
          ))}
        </div>

        {/* Campaign Cards */}
        <div className="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {filteredCampaigns.map((campaign) => (
            <div
              key={campaign.id}
              className="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300"
            >
              <img
                src={campaign.image}
                alt={campaign.title}
                className="w-full h-48 object-cover"
              />
              <div className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <span className="px-3 py-1 text-sm font-medium text-blue-600 bg-blue-50 rounded-full">
                    {campaign.category}
                  </span>
                  <span className="text-gray-500 text-sm">
                    Ends {new Date(campaign.deadline).toLocaleDateString()}
                  </span>
                </div>
                <h3 className="text-xl font-semibold text-gray-900 mb-2">
                  {campaign.title}
                </h3>
                <p className="text-gray-600 mb-4">
                  {campaign.description}
                </p>
                
                {/* Progress Bar */}
                <div className="mb-4">
                  <div className="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Raised: {formatAmount(campaign.raised)}</span>
                    <span>Goal: {formatAmount(campaign.goal)}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div
                      className="bg-blue-600 h-2 rounded-full transition-all duration-500"
                      style={{ width: `${calculateProgress(campaign.raised, campaign.goal)}%` }}
                    />
                  </div>
                  <div className="text-right text-sm text-gray-600 mt-1">
                    {Math.round(calculateProgress(campaign.raised, campaign.goal))}% Complete
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex gap-4">
                  <button className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors duration-200">
                    Donate Now
                  </button>
                  <button className="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors duration-200">
                    Share
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Start Campaign Button */}
        <div className="mt-12 text-center">
          <button 
            onClick={() => setShowModal(true)}
            className="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-sm">
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Donation
          </button>
        </div>

        {/* Modal for Adding Donation */}
        {showModal && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div className="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
              <div className="mt-3">
                <h3 className="text-lg font-medium leading-6 text-gray-900 mb-4">
                  Add New Donation
                </h3>
                <form onSubmit={handleSubmit}>
                  <div className="mb-4">
                    <label className="block text-gray-700 text-sm font-bold mb-2">
                      Alumni *
                    </label>
                    <select
                      name="alumni_id"
                      value={formData.alumni_id}
                      onChange={handleInputChange}
                      required
                      className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    >
                      <option value="">Select an alumni</option>
                      {alumniList.map((alumni) => (
                        <option key={alumni.id} value={alumni.id}>
                          {alumni.first_name} {alumni.last_name} - {alumni.email}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div className="mb-4">
                    <label className="block text-gray-700 text-sm font-bold mb-2">
                      Amount (PHP) *
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      name="amount"
                      value={formData.amount}
                      onChange={handleInputChange}
                      required
                      className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                      placeholder="0.00"
                    />
                  </div>
                  <div className="mb-4">
                    <label className="block text-gray-700 text-sm font-bold mb-2">
                      Date
                    </label>
                    <input
                      type="date"
                      name="date"
                      value={formData.date}
                      onChange={handleInputChange}
                      className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    />
                  </div>
                  <div className="mb-4">
                    <label className="block text-gray-700 text-sm font-bold mb-2">
                      Purpose
                    </label>
                    <input
                      type="text"
                      name="purpose"
                      value={formData.purpose}
                      onChange={handleInputChange}
                      className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                      placeholder="Purpose of donation"
                    />
                  </div>
                  {error && (
                    <div className="mb-4 text-red-600 text-sm">
                      {error}
                    </div>
                  )}
                  <div className="flex items-center justify-end gap-3">
                    <button
                      type="button"
                      onClick={() => {
                        setShowModal(false);
                        setError('');
                      }}
                      className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      disabled={loading}
                      className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-400"
                    >
                      {loading ? 'Adding...' : 'Add Donation'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        )}

        {/* Display Donations List */}
        {donations.length > 0 && (
          <div className="mt-16 bg-white rounded-lg shadow-md p-8">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">Recent Donations</h2>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purpose</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {donations.map((donation) => (
                    <tr key={donation.id}>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {donation.date ? new Date(donation.date).toLocaleDateString() : 'N/A'}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        â‚±{parseFloat(donation.amount).toLocaleString()}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        {donation.purpose || 'General donation'}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Additional Information */}
        <div className="mt-16 bg-white rounded-lg shadow-md p-8">
          <h2 className="text-2xl font-bold text-gray-900 mb-4">Why Donate?</h2>
          <div className="grid md:grid-cols-3 gap-8">
            <div>
              <div className="flex items-center mb-3">
                <svg className="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                <h3 className="text-lg font-semibold">Make an Impact</h3>
              </div>
              <p className="text-gray-600">Your donations directly support student scholarships and campus improvements.</p>
            </div>
            <div>
              <div className="flex items-center mb-3">
                <svg className="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <h3 className="text-lg font-semibold">Secure Donations</h3>
              </div>
              <p className="text-gray-600">All transactions are secure and protected by industry-standard encryption.</p>
            </div>
            <div>
              <div className="flex items-center mb-3">
                <svg className="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                <h3 className="text-lg font-semibold">Tax Deductible</h3>
              </div>
              <p className="text-gray-600">Your donations may be tax-deductible according to Philippine tax laws.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Donations;